在 Android 的消息机制中，**同步屏障（Sync Barrier）** 是一种特殊的消息，它像一道“关卡”，会阻塞普通消息的处理，**优先执行异步消息**（通常是高优先级的 UI 绘制或输入事件）。它的核心作用是确保关键任务（如界面渲染）不被普通消息阻塞。

---

### **1. 同步屏障的核心特性**

|特性|说明|
|---|---|
|**优先级**|最高优先级，一旦插入，会阻塞后续普通消息的处理。|
|**触发条件**|由系统在需要紧急处理时插入（如 `VSYNC` 信号触发的 UI 绘制）。|
|**消息类型**|异步消息（`Message.setAsynchronous(true)`）才能越过屏障。|
|**生命周期**|临时存在，执行完异步消息后会被移除。|

---

### **2. 同步屏障的工作原理**

#### **(1) 消息队列的默认行为**

正常情况下，`MessageQueue` 按消息的 **时间顺序（`when`）** 处理：

plaintext

复制

下载

MessageQueue: [消息A(when=10ms)] → [消息B(when=20ms)] → [消息C(when=30ms)]

`Looper` 依次取出处理，没有优先级区分。

#### **(2) 插入同步屏障后**

当系统插入同步屏障（如 `ViewRootImpl.scheduleTraversals` 触发 UI 绘制）：

plaintext

复制

下载

MessageQueue: [屏障] → [消息A(when=10ms)] → [异步消息D(when=15ms)] → [消息B(when=20ms)]

- **屏障后的行为**：
    
    - `Looper` 遇到屏障时，会跳过所有普通消息（A、B），只执行 **异步消息（D）**。
        
    - 屏障被移除后，恢复普通消息处理。