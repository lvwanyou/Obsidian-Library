在 Android 的消息机制中，**同步屏障（Sync Barrier）** 是一种特殊的消息，它像一道“关卡”，会阻塞普通消息的处理，**优先执行异步消息**（通常是高优先级的 UI 绘制或输入事件）。它的核心作用是确保关键任务（如界面渲染）不被普通消息阻塞。

---

### **1. 同步屏障的核心特性**

|特性|说明|
|---|---|
|**优先级**|最高优先级，一旦插入，会阻塞后续普通消息的处理。|
|**触发条件**|由系统在需要紧急处理时插入（如 `VSYNC` 信号触发的 UI 绘制）。|
|**消息类型**|异步消息（`Message.setAsynchronous(true)`）才能越过屏障。|
|**生命周期**|临时存在，执行完异步消息后会被移除。|

---

### **2. 同步屏障的工作原理**

#### **(1) 消息队列的默认行为**

正常情况下，`MessageQueue` 按消息的 **时间顺序（`when`）** 处理：

plaintext

复制

下载

MessageQueue: [消息A(when=10ms)] → [消息B(when=20ms)] → [消息C(when=30ms)]

`Looper` 依次取出处理，没有优先级区分。

#### **(2) 插入同步屏障后**

当系统插入同步屏障（如 `ViewRootImpl.scheduleTraversals` 触发 UI 绘制）：

plaintext

复制

下载

MessageQueue: [屏障] → [消息A(when=10ms)] → [异步消息D(when=15ms)] → [消息B(when=20ms)]

- **屏障后的行为**：
    
    - `Looper` 遇到屏障时，会跳过所有普通消息（A、B），只执行 **异步消息（D）**。
        
    - 屏障被移除后，恢复普通消息处理。



### 5. **开发者注意事项**

- **慎用同步屏障**：  
    同步屏障是系统级机制（如 `ViewRootImpl` 内部使用），开发者通常无需手动调用。错误使用可能导致消息饥饿或 ANR。
    
- **异步消息的标记**：  
    若需发送异步消息，需显式设置：
    
    java
    
    Message msg = Message.obtain();
    msg.setAsynchronous(true); // 标记为异步
    handler.sendMessage(msg);
    

---

### 6. **底层原理图解**

plaintext

MessageQueue 示例（竖列为链表顺序）：
---------------------
| 同步消息 A          | ← 普通消息
| 同步屏障（target=null）| ← 插入屏障
| 同步消息 B          | ← 被阻塞
| 异步消息 C (async=true)| ← 优先执行
---------------------

---

### 总结

同步屏障是 Android 消息机制中的一种**优先级控制策略**，通过临时阻塞同步消息，确保关键异步任务（如界面渲染）能及时执行。其核心是通过 `MessageQueue` 内部的状态判断和消息过滤实现的，属于系统优化高优先级任务的重要手段。